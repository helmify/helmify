name: Deploy a new Helmify Tester
description: Deploy a new Helmify Tester

inputs:
  name:
    required: true
    description: 'Tester name'
  chartFlavor:
    required: true
    description: 'The chart flavor to use (helm|bitnami)'

runs:
  using: "composite"
  steps:
    - name: Clean up
      shell: bash
      run: |
        rm -rf ${{ inputs.name }}.zip
        rm -rf ${{ inputs.name }}-chart
    - name: Deploy ${{ inputs.name }} Tester
      shell: bash
      run: |
        curl -X POST --data @testing/${{ inputs.name }}/pom.xml  -o ${{ inputs.name }}.zip -H "Content-Type: application/json" "http://localhost:8080/api/cli?name=${{ inputs.name }}&version=0.1.0&chartFlavor=${{ inputs.chartFlavor }}" \
        && unzip ${{ inputs.name }}.zip -d ${{ inputs.name }}-chart \
        && cd ${{ inputs.name }}-chart/helm && helm dependency update \
        && kind load docker-image ${{ inputs.name }}:0.1.0 --name chart-testing \
        && helm install ${{ inputs.name }} . \
    - name: Wait for Tester
      shell: bash
      run: |
        max_attempts=12 # 2 minutes / 10 seconds per attempt
        attempt=0
        
        until kubectl get pods --all-namespaces --no-headers | awk '{print $2}' | grep -q '^[0-9]*\/[0-9]*\sReady$'; do
          
          if [ $attempt -ge $max_attempts ]; then
            echo "Timeout: Maximum attempts reached. Exiting..."
            exit 1
          fi
        
          echo "Waiting for all pods to be ready..."
          # Fetch pods that are not in the 'Ready' state
          pods_not_ready=$(kubectl get pods --all-namespaces --no-headers | awk '{print $2}' | grep -v '^[0-9]*\/[0-9]*\sReady$')
          
          # For each pod not in the 'Ready' state, describe the pod to get more information, including events
          for pod in $pods_not_ready; do
            echo "Pod $pod is not ready. Fetching events..."
            kubectl describe pod $pod
          done
          
          sleep 10
          attempt=$((attempt+1))
        done
